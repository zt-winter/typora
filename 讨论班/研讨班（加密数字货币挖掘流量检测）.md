# 研讨班（加密数字货币挖掘流量检测）

## 区块链

![默克尔树](D:\typora\讨论班\研讨班图片\默克尔树.png)

![区块链结构图](D:\typora\讨论班\研讨班图片\bicon数据结构.jpg)

### 区块链基本原理

​		由于区块链中涉及的技术点多，并且分散。很难在短时间系统的对区块链做一个细致全面的介绍。所以我以挖矿矿工的视角来对区块链做一个说明。

__矿工在比特币网络中的位置__：

​		比特币网络是一个P2P网络结构，网络中节点分为两类：全节点和轻节点。全节点包含了区块链上的全部信息，在比特币网络中有信息路由、发起接收交易、验证交易信息、区块链更新投票（这个后面会说明）。轻节点只包含区块链中所有的区块头，在比特币网络中有信息路由、发起接收交易功能，但在区块链网络中要进行交易验证需要向全节点发起验证请求，也无法参入区块链的更新投票

​		比如一个轻节点得到了一个交易信息，它想验证这个交易信息是否正确，它首先得找到这个交易信息包含在比特币区块链哪个块中，一般根据交易的时间戳寻找时间相近的区块，（在bitcoin网络中，轻节点有可能会遍历所有的区块），然后向全节点请求验证交易信息，全节点会发送待验证的交易信息在默克尔树路径上所有的伴随哈希值，然后轻节点自己接收后计算验证。这样既验证了交易，又保证其他无关的交易信息不会被泄露。

__我在电脑上挖矿需要做什么内容__

​		__账户__ ：首先填入自己在挖矿程序中填入自己的账户，如果挖到矿了，得到的比特币会记录到自己的账户中。在bitcoin中，每个人可以通过椭圆曲线生成一对公私钥，公钥作为账户，私钥作为密码。A将bitcoin转给B，则需要A的私钥和B的公钥，A的私钥作为签名，B的公钥作为加密，这样只有B可以用他自己的私钥解密，然后用A的公钥验证是否是A转给他的。

​		__UTXO__：同时我们会在自己电脑的内存中维护一个叫做UTXO的数据结构，全称为unspent transaction output。没有被花掉的钱，保存所有交易用户剩下的钱。整个比特币网络中之前发生的所有的被验证了的交易记录都保存在UTXO中。什么是被验证了的交易记录？就是写入到区块链的一个块中，并且这个块后面还有至少6个块。

 ![交易确认](D:\typora\讨论班\研讨班图片\交易确认.png)

```
//一个人c收到过两笔交易，一个是a转给c的1比特币，一个是b转给c的0.5比特币。那么在UTXO中就会有两条记录
UTXO(1) a->c 1 bitcoin
UTXO(2) b->c 0.5 bitcoin
//现在c要给d转账，金额为1.2个比特币
UTXO(3) c->d 1.2 bitcoin
UTXO(4) c->c 0.2999 bitcoin
//之前的UTXO(1)和UTXO(2)的记录会被消除，UTXO(3)和UTXO(4)的记录会产生。
```

![区块链交易图](D:\typora\讨论班\研讨班图片\区块链交易图.png)

上图是在区块链中发生的交易关系图。A在给B和C转账时需要做的事情：

* 知道B的公钥地址，因为公钥地址可以推算出B的钱包，也就是B的账户。B的公钥地址无法直接在比特币网络中查到，就像现实生活中A向B转账，无法通过银行查询B的账号。需要A和B通过其他沟通方式获得。
* 需要指出A自己要转账的钱的来源，也就是上一个交易的记录的位置。这个A自己知道，在图中也就是指向上一个交易的哈希指针。
* A需要用自己的私钥给交易内容签名，确认这个交易是自己发起的。这个A自己拥有
* A需要在交易信息中公开自己的公钥，确保比特币网络中任何节点都能用A的公钥验证A的签名

​		

​		__交易信息__：我们在挖矿过程中如果比特币网络有一笔交易被发布了出来，此时该交易并没有被认证。我们挖矿过程中在比特币网络中收到了这个交易信息，就可以把这个交易信息记录到哈希节点的区块体中。我们如果挖矿成功了，交易过程中交易费也会由我们获得。这样设计可以鼓励挖矿者将交易记录到区块中。

​		__挖矿的主要工作__：计算hash值，H(区块头) < target。其中区块头中能够调节的值目前仅为随机数nonce，我们要做的就是不断调整随机数nonce，使得H(区块头) < target。如果找到了，就可以把该节点发布出来。在发布节点的交易信息中会有一个铸币交易，表示没有任何人给我们转账，而是由于挖到了矿而获得比特币奖励。比特币中为了维持挖出节点时间的稳定，设计了一个难度值。

```
true target = target/difficulty
难度值越高，真实目标值越小，能够符合要求的块就越少。
比特币中每隔2016个块，就会调整一次难度，保证平均每次出块时间维持在10分钟。
```

​	我们在执行挖矿程序时，比特币网络平均10分钟挖到一个块，因此在这10分钟内，也就是一个块被挖到前，我们挖到矿的概率为` P(X) = 自身算力/全网算力`。一旦其他人挖到了，那么我们要挖的区块中区块头的父区块哈希值就会发生改变，前面10分钟所做的计算都没用了。我们挖到矿的概率就几乎不会随着时间的变化，因为排除大量错误随机数而提升，挖到矿的概率只与占全网算力的比值有关。

​		当我们挖到一个块，然后发布到比特币网络中后，网络中的任何节点都可以计算验证H(区块头) 是否小于 真实目标值。挖到矿后可以把块写到区块链中，而一个区块包括了许多交易信息，所以也可以说挖矿这一过程实际上是在争夺记账权，也就是只有发布到区块链上的区块能够确认交易信息。也可以说挖矿的过程保证了区块链网络中的交易能够及时被验证并写入到区块链中，同时保证了攻击者很难修改交易信息（或者说发布错误的交易信息），因为这种攻击行为需要攻击者有大量的算力。这也能说明区块链保证信息很难被篡改的前提条件是攻击者无法掌握50%以上的算力。之前说到过一个区块里的交易信息要等到六个区块发布后才算正式生效，写入到UTXO中。也就是说一个交易完成确认平均需要60分钟。在这60分钟里，如果发布交易信息的节点把假的交易信息发布出来，正常用户发布的新的节点会发现发现问题，而不承认这个节点，从而产生另外一条支链。只要比特币网络中大部分用户是正常用户，那么正常用户这条支链的长度就会越来越长，攻击者所在的支链就会被废弃。挖矿使用的算力成为了区块链安全的保障。



![分叉](D:\typora\讨论班\研讨班图片\分叉情况.png)

​		如当a挖到一个块C，并发布到区块链中。a不满足于挖到块的出块奖励，所以他在自己发布的块中写入一条交易信息，b给a转了100个比特币，但实际这次交易并没有发生，这样a凭空多出来了100个比特币。但后续其他人挖到块D，块D会验证C中交易信息是否正确，发现错误后，D块就加入到B后面，并不会跟在C后面。这样就出现分叉，后面块都需要做出选择，跟在哪个块后面。系统约定正常的区块需要跟在最长合法链后面。只要比特币系统中大部分的算力在正常矿工手上，正常的分链就会被广泛承认，异常的分链就会被抛弃。同时异常的分链上的区块的出块奖励就没有，这个作为恶意攻击者、有意帮助恶意攻击的人、故意捣乱的人的惩罚，他们消耗大量资源计算得到的合格区块都没有收益。

​		比特币的成功除了有合理的技术使用，更重要是精妙的设计了奖励系统和交易系统。其中还有利用算力作为信任凭证的技巧、博弈论的思想。



​		__虚拟加密货币的发展：__比特币作为虚拟加密货币成功后，币值不断飞升。参与比特币挖矿的人越来越多，挖矿的竞争越来越激烈。这导致两种现象的出现。

* 挖矿的设备不断提高	收益比（挖矿收益/运行成本）高的设备不断出现。最开始挖矿是使用CPU，但挖矿只使用了CPU的整数运算，如CPU的浮点数运算对于挖矿都没有什么用处。后来开始使用GPU并行计算哈希值挖矿。最后开始有人设计针对挖矿哈希算法的专用计算芯片APU，然后给芯片厂流片批量生产。设备的不断更新，造成了普通人挖矿越来越难。而比特币设计的初衷是一般人都能参与进来。参与的人越多，这条区块链越安全。
* 矿场开始出现    由于个人算力有限，如果单独挖矿，那么挖到矿的概率基本为0，这样风险太高。于是矿场开始出现，它负责将寻找一个满足要求哈希值问题进行分割，然后分配给每个矿工。由矿工合力计算下一个块的正确哈希值。但只有矿场知道全局信息，所以一样有可能造成有人拥有的算力在全网的占比超过50%。之前就有矿场的算力占全网算力比值超过50%，让人们对比特币的可靠性产生了怀疑，最后该矿场自己解散了矿场。

这两种现象都反映出比特币的一些缺点，算力作为信任的凭证不是完全合理的。所以后续开始新的虚拟加密货币对这个缺点进行弥补。如门罗币对哈希值的算法进行重新设计，通过数学设计造成GPU、APU相对于CPU并不占优势，使挖矿能够参与的人更多；降低出块的时间，这样可以降低交易确认的时间，币值虽然不高，但挖到矿相对于比特币容易很多，更多人容易参与进来。



## __恶意挖矿行为：__

​		由于比特币等虚拟货币币值飞速攀升，大量恶意攻击者开始攻击感染他人主机，然后使用他人的设备、电力资源进行虚拟加密货币挖掘。这种行为对受害者的服务器等设备造成了严重的运行影响，也消耗了电力资源，造成直接经济损失。

​		恶意挖矿行为目前可以主要分为两种

* 在网站中嵌入挖矿的脚本，当用户访问网站时，挖矿的脚本调用用户主机的CPU，执行哈希值计算。当用户被告知会使用CPU挖矿作为网站盈利时，是一种正常的商业模式，与广告类似。但在用户不知情的情况下，使用CPU是恶意行为。同时这种恶意行为发生的原因也有两种情况，一种是网站运营者自身为了获取利益，自己在网站中嵌入挖矿脚本。另一种是有恶意攻击者在网站挂上了第三方的挖矿脚本，网站运营者并不知情。
* 攻击者制作挖矿木马，由U盘文件传输、网络下载文件等方式进入用户的电脑。然后控制用户的CPU、GPU等计算资源进行挖矿。这种行为与传统的病毒木马并没有本质区别，但由于这类恶意软件都是以挖矿，并将收益传给攻击者，所以在网络流量、受害主机的资源消耗上都一些特别的特征。



虚拟货币受到越来越多的人的关注，学术界也对挖矿行为进行了研究，特别是在恶意挖矿行为检测方面进行了深入研究。下面是近些年相关的研究论文。

| 论文标题                                                     | 研究内容                         | 主要方法                                                     | 发表信息                                                     |
| :----------------------------------------------------------- | :------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| Detection and Prevention of Malicious Cryptocurrency Mining on Internet-Connected Devices | web挖矿与软件挖矿检测            | web挖矿：URL黑名单匹配、JS脚本挖矿代码匹配、virustotal查询<br />软件挖矿：DNS黑名单匹配、数据包检测字段匹配 | ICFNDS<br />18                                               |
| <font color=red size=4>__Outguard: Detecting In-Browser Covert Cryptocurrency Mining in the Wild__</font> | web挖矿检测                      | 选取了web挖矿时js脚本执行时的各方面特征，使用SVM，使得检测准确率到达了96.2%~97.9% | WWW(A)<br />19                                               |
| POSTER: Detecting WebAssembly-based Cryptocurrency Mining    | 检测使用webAssembly技术的web挖矿 | 通过挖矿过程中浏览器CPU占用率、TOP命令占比等检测             | CCS（短文）<br />19                                          |
| Detecting Cryptomining Using Dynamic Analysis                | web挖矿检测                      | 通过监测web挖矿过程中CPU执行的汇编代码                       | PST<br />18                                                  |
| Detecting cryptocurrency  miners with  NetFlow/IPFIX network measurements | 矿池通信检测                     | 使用netflow或者ipfix(IP flow information export)的统计信息判断是否有挖矿活动，比DPI消耗资源更少 | M&N<br />19                                                  |
| Dissecting Android Cryptocurrency Miners                     | android挖矿应用                  | Monero(门罗币)等虚拟货币是可以用手机CPU挖<br />静态检测：特征代码匹配<br />动态检测：将应用执行时CPU各项指标作为主要特征，使用机器学习方法检测挖矿 | CODASPY ’20<br />20                                          |
| How to detect cryptocurrency miners? By traffic forensics!   | 流量检测挖矿行为                 | 人工选择并验证了一些流量特征，用于机器学习识别矿池流量检测   | Digital Investigation<br />19                                |
| Demystifying Cryptocurrency Mining Attacks A Semi-supervised Learning Approach Based on Digital Forensics and Dynamic Network Characteristics | 流量检测挖矿行为                 | 通过半监督学习，利用流量特征识别挖矿行为。SNN作为聚类算法，KNN作为后期监督学习算法 | CoRR abs<br />21                                             |
| BotcoinTrap: Detection of Bitcoin Miner Botnet Using Host Based Approach | 终端检测挖矿                     | 挖矿时会读取内存中文件数据，根据其特征发现挖矿行为           | ISCISC<br />18                                               |
| DeCrypto Pro: Deep Learning Based Cryptomining Malware Detection Using Performance Counters | 终端检测挖矿                     | 使用CPU占用率，各核心使用情况，内存使用情况，使用LSTM模型检测 | ACSOS<br />20                                                |
| <font color=red size=4>__Cryptomining Cannot Change Its Spots: Detecting Covert Cryptomining Using Magnetic Side-Channel__</font> | 侧信道检测                       | 挖矿过程中会反复使用the core PoW algorithm，产生特定的电磁特征 | TIFS(IEEE TRANSACTIONS ON INFORMATION FORENSICS AND SECURITY)<br />20 |
| Detecting Cryptomining Malware: a Deep Learning Approach for Static and Dynamic Analysis | 终端检测                         | 通过挖矿软件调用的库函数和反汇编后的汇编代码序列提取特征，使用LSTM和CNN模型训练 | J Grid Computing<br />20                                     |
| Detection of Encrypted Cryptomining Malware Connections With Machine and Deep Learning | 容器检测                         |                                                              | IEEE ACCESS                                                  |
| <font color = red size =4>__Cryptomining makes noise: Detecting cryptojacking via Machine Learning__</font> | 流量检测                         | 对单独挖矿作为全节点和参与矿池分别做了识别（主要是全节点的交易信息同步），同时对vpn加密条件下的流量进行了检测，特征为包长、流时间长度，模型为随机森林。 | CC(Computer Communications)<br />21                          |
| <font color=red size=4>__MineSweeper: An In-depth Look into Drive-by Cryptocurrency Mining and Its Defense__</font> | web挖矿检测                      | 主要还是使用了wasm，CPU占用率、每级缓存使用情况、通信时关键字段 | CCS<br />18                                                  |

![攻击场景](D:\typora\讨论班\研讨班图片\攻击场景.png)

​		现在主流的检测思路：受害主机计算哈希的结果总是要回传给攻击者或者矿场，所以在网络通信过程中捕获流量分析。针对现在大量网站出现挖矿脚本的情况，有专门针对浏览器挖矿脚本的检测方式，主要通过浏览器调用的函数库、线程数量、执行时相关性能参数检测。还有部署到受害者主机上，然后对整个终端进行检测，这种一般检测恶意代码、异常进程、CPU、GPU等异常使用。

​		目前学术研究常见方法的缺点：终端检测和浏览器检测提取的特征比较粗，像CPU、GPU占用率、浏览器使用占用率、浏览器线程数量等作为特征，识别率虽然能够达到一个比较高的程度，但误报率也非常高。同时，如果要对大范围的设备进行挖矿检测，终端和浏览器检测只能部署到每台机器上，有很大的局限性。流量检测中主要针对的是明文流量，使用的最多的是包长、关键字特征，一旦攻击者使用加密通信，则可以规避检测。现在目前相关的后续研究点主要集中降低误报率，同时在通信加密的情况下进行识别，大量不同的虚拟加密货币识别。上面21年Computer Communications的一篇论文就加密挖矿通信进行了研究，但这篇论文在数据集上不具有通用性。它将加密的挖矿通信流量分别混在音视频流量、系统流量中，这样环境太过理想。在CCS18年的这篇论文中，存在挖矿行为的网站中，有58.1%的网站是使用明文传输模式就行挖矿通信的。这种可以直接使用关键字匹配等方式进行识别。有10.03%的被检测到使用了加密通信进行挖矿。剩下的网站作者的检测程序不能识别到矿池通信记录。

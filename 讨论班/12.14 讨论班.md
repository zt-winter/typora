# 12.14 讨论班

## 1.数据

​	作者使用了a specially instrumented browser收集了alexa前一百万的域名，并收集了站点的资源、起源（出处）、JS脚本执行过程。然后使用现有的挖矿劫持检测工具发现了来自12个不同家族的3006个挖矿劫持执行过程。作者将这些挖矿劫持行为制作为两个数据集：一个是平衡的数据集（挖矿劫持与正常行为数量相当）；另一个是不平衡的数据集，展示了现实世界中挖矿劫持的频率。

​	作者从alexa前10万中随机选择了一些网站产的信息作为正常网站信息，尽管有一些高受欢迎网站出现加密劫持的案例报告，但这些网站通常维护良好，不太可能发生新的安全事件。这些数据集涵盖了各种真实世界的网站，包括动态和高调的网站，如新闻，合法的视频流，流行公司的网站以及静态网站。这也包含了广泛的JS使用，包括高使用率的网站。

​	平衡的数据集包含2000个挖矿劫持和2000个正常网站数据，不平衡的数据集包含2700个挖矿劫持和27000个正常网站。

## 2.特征

​	作者对标注好的数据集进行分析，最后确定了4类7种特征。分别是：

* 浏览器基本信息
* 挖矿JS脚本基本信息
* 网络流量基本信息
* 加载库信息



收集统计数据后，分析出的一些无用特征：

* JS引擎执行时间 ：这个特征噪音非常大，很多网站一直都在执行JS
* JS编译时间：挖矿劫持网站在编译时间上没有明显差异
* 垃圾收集：没有从挖矿劫持库中发现与其他正常库使用时的差异
* Iframe资源加载情况：挖矿行为代码经常被加载到Iframe中，但大量的广告界面也使用Iframe，导致无法作为挖矿检测的区分。
* CPU占用：挖矿确实会直接依赖于CPU资源，但有许多正常的网站也重度使用CPU。



分析得到的7个特征

* web workers：线程多少，挖矿行为多倾向于使用多线程工作，几乎所有的12个挖矿脚本家族至少使用了3个线程。
* parraller tasks：正常网站一般都创建一个线程专门用于一个目的（如：捕获、播放视频）。作者观察发现在发生挖矿劫持的网站中，每个线程下都运行着相同的任务。重复着相同的方法调用。
* webassembly：它允许web开发人员指定类似于程序集的代码，以接近本地的速度在现代浏览器上执行。WebAssembly的性能使它成为处理密集加密的一个有吸引力的目标，我们发现我们的训练集中的所有密码劫持库都使用WebAssembly。outguard通过监控wasm模块在主执行线程和web worker之间的交换来检测WebAssembly的使用情况。这种检测技术忽略了在CoinHive的一些变体中发现的通信混淆，结果产生了一个布尔特征，表明存在或不存在WebAssembly
* websockets：大多挖矿行为都建立了与矿池、代理的websocket连接。outguard在JS执行记录中搜索websocketcreateevents，并输出websocket连接数量的特征。
* hash algorithms：挖矿劫持库挖掘最常见的加密货币是Monero，挖掘Monero需要工作量证明，工作量证明需要重复计算CryptoNight哈希算法。我们可以在JS执行调用栈中搜索特征的函数名和二进制签名识别CryptoNight哈希的使用情况。如JSECoin和一些CoinHive调用模块cryptongith_hash和cryptonightWASMWrapper.hash，这个检测结果作为一个布尔特征。
* PostMessage Event Load：worker线程需要不断地向主线程发送计算工作ID、nonce和计算的结果。然后将结果通过websocket连接发送给矿池或者代理，以便管理挖矿任务。渲染进程和web worker之间的通信是通过PostMessage来处理的。PostMessage数量作为特征。
* MessageLoop Event Load：在Chrome里，是使用MessageLoop对象来封装以上的消息处理循环代码。虽然MessageLoop的使用本身并不一定意味着一个网站正在执行加密劫持操作，但在短时间的站点访问期间出现大量的MessageLoop事件，以及其他特性，可以表明存在加密劫持。我们以数值形式报告MessageLoop事件的数量。

可以分为4类

1. 基于运行时的执行特性，WebAssembly、Web worker、parraller tasks
2. 基于网络的特征，websockets
3. 基于事件负载的特征，messageLoop Event Load、postMessage Event Load
4. 基于挖矿自身特征，hash algorithm



## 3.实验

​	作者使用SVM和RF实验了结果，最后选择了SVM作为分类器。达到了97.7%的TPR和1.1%PR。

作者将outguard部署到电脑上，然后访问alexa前一百万的网站，最后发现了6302个存在挖矿劫持。其中有3600个没有被现有的技术发现。从理论上讲，如果获得了用户的同意，浏览器内的密码挖掘不一定是恶意的，所以我们进行了额外的分析来验证，在现实中，几乎所有的密码挖掘网站都没有征求用户的同意。加密劫持主要出现在低人气网站的长尾中，这些网站推广种子或受版权保护的视频流等非法内容。我们的分析还揭露了69起通过广告网页加载的加密劫持事件。这些事件构成了非故意的加密劫持，在没有网站所有者/发布者直接参与的情况下发生。我们研究了加密劫持的交付和加密劫持货币化的协调。我们根据源代码来源将加密劫持事件分为14个主要家族，并发现了5个家族的竞争性混合，总共占加密劫持事件的70%以上。我们还发现了486起使用24个不太知名的加密挖掘服务的加密劫持事件。这些服务提供池采矿服务，收费仅为采矿总收入的1%。最后，我们进行了一项活动分析，确定了35个加密劫持活动，规模从2个到121个网站不等。这些网站提供不同类型的加密劫持库，如CoinHive、JSeCoin和Crypto-loot。

​	作者使用chromium浏览器的chromium调试协议爬虫浏览器请求和响应跟踪，JavaScript执行跟踪以及内联和动态加载JavaScript代码的源代码。作者在40台虚拟机上部署了outguardcrawler。对于每个网站，爬虫停留在被访问的网站上45秒，并通过编程滚动页面底部来模拟用户行为与页面进行交互。我们根据经验发现，45秒的时间足以让一个加密劫持网站加载一个加密劫持库，与挖掘池通信，并运行挖掘任务。我们对1,000个随机选择的网站的分析表明，调试模式爬虫运行时开销约为2%。

​	使用SVM和RF模型，两个的TPR均在95%以上，FPR均低于3%。但SVM在两个训练集上的表现略优于RF。最后选择SVM。

## 4.实验分析

### 4.1结果分析

​		outguardsvm在BD和ID数据集的TPR分别达到96.2%和97.9%，在ID数据集上的假阳率（FP）为1.1%，共32个。人工分析这32个假阳显示，这些网站平均有29个JS脚本。主要因为使用了websocket连接通信，一些脚本为了传输客户端的数据使用多线程。

​	分析真阴结果，outguardwas不能检测CoinImp的部分变体，因为它们在执行过程中不含特征中的函数调用，而且使用的web worker数量小于3个。

### 4.2特征分析

​	为了研究各个特征的重要性，作者在BD数据集上对SVM模型进行递归特征消除（RFE）。每一次将权重最小的特征删除，然后重新计算FP和TP，以此衡量该特征的重要性。

![](D:\typora\讨论班\微信图片_20211208190139.png)

​	CPU利用率特征的有效性。之前的研究中有监测CPU利用率，并构建模型检测挖矿的方法。作者在BD训练集中跟踪了所有CPU利用率超过50%的网站。来自所有12个挖矿脚本家族的劫持挖矿库的CPU利用率在50%以上。但将CPU利用率启发式算法用BD数据集测试，误报率为13.1%。人工检查误报情况发现，正常网站由于大量请求响应、持续的JS编译以及脚本加载时DOM中频繁的动态更改，会带来较高的CPU占用，如cnn.com（新闻网站）。

### 4.3原型系统的鲁棒性(Adversarial Considerations)

​	挖矿劫持脚本的编写人员可能会通过改变实施策略使用技术手段避开outguard的检测。作者为了测试潜在的规避场景，评估了outguard在缺少特定类别下的有效性。

![](D:\typora\讨论班\微信图片_20211208192741.png)

从盈利的角度来看，在加密劫持库中使用运行时特性(例如WebAssembly)是至关重要的，因为这些库必须包含这样的浏览器功能才能有效地使用系统资源。如果做不到这一点，就会使浏览器内的密码挖掘变得不实用，或者在创收方面的吸引力降低。

## 5.实际部署测试

![](D:\typora\讨论班\微信图片_20211208193234.png)

​	在浏览器中挖矿本身并不一定是恶意的，缺乏用户同意是区别是否的恶意的重要依据。作者对发现的挖矿行为中包含JSECoin库的网站进行了手工分析，发现22%的网站无法访问，78%的网站在未经用户同意的情况下自动执行。2017年，CoinHive推出了一个叫AuthedMine的挖矿库，它需要用户同意才能通过浏览器挖矿，但作者并没有发现有网站使用这种库。实验表明大多数网站运营者并不愿意告知用户在使用CPU挖矿，绝大部分情况下都是恶意挖矿劫持。

​	之前浏览器中屏蔽挖矿的扩展都是通过过滤已知的矿池，然而矿池开始采用合法的云部署服务，阻止云服务的域名或者IP是不可行的。

## 6.恶意挖矿劫持网站测量分析

​	有恶意挖矿劫持的网站Alexa排名，220个在前100K（3.5%），602个在前100K到前1M之间（9.6%），5480个在前1M之后（87%）。

![](D:\typora\讨论班\微信图片_20211208200252.png)

![](D:\typora\讨论班\微信图片_20211208200404.png)

我们发现最受加密劫持的域名通常是包含非法内容的网站，如torrent托管网站、视频下载/流媒体网站和恶意网站。假设大多数这些加密劫持事件不是网站泄露的结果，这些结果表明，犯罪行为者比合法行为者更成功地使用加密劫持。

恶意挖矿劫持生命周期。在3个月的时间里每10天抓取5873个网站。32%的挖矿劫持网站10天内恶意行为变得不活跃，1552个网站（26.4%）持续了3-9周，619个网站（10.5%）保持活跃，这些大部分是音视、游戏、应用下载网站。在1552个活跃的网站中，有68个（3.1%）属于Alexa排名前10的网站。说明现有的解决方案效果不是很好。
